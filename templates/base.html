{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Scheduler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body {
    padding-left: 250px;
    padding-top: 20px;
  }

  @media (max-width: 991px) {
    body {
      padding-left: 0;
    }
  }

  .sidebar {
    width: 250px;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    background-color: #212529;
    padding: 1rem;
    overflow-y: auto;
    z-index: 1040;
  }

  .sidebar .nav-link {
    color: #ffffff;
  }

  .sidebar .nav-link:hover {
    background-color: #343a40;
  }

  .sidebar .dropdown-toggle::after {
    float: right;
    margin-top: 0.4rem;
  }

  .navbar.fixed-top {
    z-index: 1050;
    left: 250px;
    width: calc(100% - 250px);
  }

  @media (max-width: 991px) {
    .navbar.fixed-top {
      left: 0;
      width: 100%;
    }
  }
</style>

</head>

<!-- Modal principal -->
<div class="modal fade" id="mainModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="modalContent"></div>
  </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirmar Exclusão</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir este item?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="confirmDeleteBtn" type="button" class="btn btn-danger">Excluir</button>
      </div>
    </div>
  </div>
</div>


<body class="bg-light">

{% if user.is_authenticated %}
<!-- Sidebar desktop -->
<div class="sidebar d-none d-lg-block text-white">
  <div class="text-center mb-4">
    <img src="{% static 'core/logo.png' %}" alt="Logo" style="width: 50px;">
    <div class="fw-bold mt-2">Scheduler</div>
  </div>

  <ul class="nav flex-column">
    <li><a class="nav-link" href="{% url 'dashboard' %}"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>

    {% if user.role == "COORDINATOR" %}
    <li><a class="nav-link" href="{% url 'lead_list' %}"><i class="bi bi-person-lines-fill me-2"></i> CRM</a></li>

    <li class="nav-item">
      <a class="nav-link text-white dropdown-toggle {% if request.path|slice:"1:9" == 'teachers' or request.path|slice:"1:9" == 'students' or request.path|slice:"1:10" == 'classrooms' %}show{% endif %}" 
        data-bs-toggle="collapse" 
        href="#gestaoSubmenu" 
        role="button"
        aria-expanded="{% if request.path|slice:"1:9" == 'teachers' or request.path|slice:"1:9" == 'students' or request.path|slice:"1:10" == 'classrooms' %}true{% else %}false{% endif %}" 
        aria-controls="gestaoSubmenu">
        <i class="bi bi-gear me-2"></i> Gestão
      </a>
      <div class="collapse {% if request.path|slice:"1:9" == 'teachers' or request.path|slice:"1:9" == 'students' or request.path|slice:"1:10" == 'classrooms' %}show{% endif %}" id="gestaoSubmenu">
        <ul class="btn-toggle-nav list-unstyled ps-4">
          <li><a class="nav-link text-white" href="{% url 'teachers_manage' %}">Professores</a></li>
          <li><a class="nav-link text-white" href="{% url 'students_manage' %}">Alunos</a></li>
          <li><a class="nav-link text-white" href="{% url 'classrooms_manage' %}">Turmas</a></li>
        </ul>
      </div>
    </li>

    <li class="nav-item">
      <a class="nav-link dropdown-toggle" data-bs-toggle="collapse" href="#agendaMenu" role="button">Agenda</a>
      <div class="collapse" id="agendaMenu">
        <a class="nav-link ps-4" href="{% url 'sessions' %}">Sessões</a>
        <a class="nav-link ps-4" href="{% url 'teachers_schedule_month' %}">Escala mensal</a>
        <a class="nav-link ps-4" href="{% url 'manage_unavailabilities' %}">Indisponibilidades</a>
      </div>
    </li>

    <li class="nav-item">
      <a class="nav-link dropdown-toggle" data-bs-toggle="collapse" href="#relatorioMenu" role="button">Relatório</a>
      <div class="collapse" id="relatorioMenu">
        <a class="nav-link ps-4" href="{% url 'report' %}">Relatório</a>
      </div>
    </li>
    {% elif user.role == "TEACHER" %}
      <li><a class="nav-link" href="{% url 'teacher_schedule_detail' teacher_id=user.id %}">Minha Agenda</a></li>
    {% endif %}
  </ul>
</div>
{% endif %}

<!-- Sidebar Mobile -->
<div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="sidebarMobile">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Menu</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <ul class="nav flex-column">
      <li><a class="nav-link text-white" href="{% url 'dashboard' %}">Dashboard</a></li>

      {% if user.role == "COORDINATOR" %}
      <li>
        <a class="nav-link dropdown-toggle text-white" data-bs-toggle="collapse" href="#gestaoMobile" role="button">Gestão</a>
        <div class="collapse" id="gestaoMobile">
          <a class="nav-link text-white ps-3" href="{% url 'teachers_manage' %}">Professores</a>
          <a class="nav-link text-white ps-3" href="{% url 'students_manage' %}">Alunos</a>
          <a class="nav-link text-white ps-3" href="{% url 'classrooms_manage' %}">Turmas</a>
        </div>
      </li>
      <li>
        <a class="nav-link dropdown-toggle text-white" data-bs-toggle="collapse" href="#agendaMobile" role="button">Agenda</a>
        <div class="collapse" id="agendaMobile">
          <a class="nav-link text-white ps-3" href="{% url 'sessions' %}">Sessões</a>
          <a class="nav-link text-white ps-3" href="{% url 'teachers_schedule_month' %}">Escala mensal</a>
          <a class="nav-link text-white ps-3" href="{% url 'manage_unavailabilities' %}">Indisponibilidades</a>
        </div>
      </li>
      <li>
        <a class="nav-link dropdown-toggle text-white" data-bs-toggle="collapse" href="#relatorioMobile" role="button">Relatório</a>
        <div class="collapse" id="relatorioMobile">
          <a class="nav-link text-white ps-3" href="{% url 'report' %}">Relatório</a>
        </div>
      </li>
      {% elif user.role == "TEACHER" %}
      <li><a class="nav-link text-white" href="{% url 'teacher_schedule_detail' teacher_id=user.id %}">Minha Agenda</a></li>
      {% endif %}
    </ul>
  </div>
</div>

<!-- Topbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm fixed-top" style="left: 250px;">
  <div class="container-fluid px-3">
    {% if user.is_authenticated %}
    <button class="btn btn-outline-dark d-lg-none me-3" data-bs-toggle="offcanvas" data-bs-target="#sidebarMobile">
      <i class="bi bi-list"></i>
    </button>
    {% endif %}
    <a class="navbar-brand fw-bold" href="#">Scheduler</a>

    {% if user.is_authenticated %}
    <div class="ms-auto">
      <span><strong>{{ user.get_full_name|default:user.username }}</strong> ({{ user.role|title }})</span>
      <form action="{% url 'logout' %}" method="post" class="d-inline ms-3">
        {% csrf_token %}
        <button class="btn btn-outline-danger btn-sm">Sair</button>
      </form>
    </div>
    {% endif %}
  </div>
</nav>

<!-- Conteúdo -->
<main class="pt-5 mt-5 px-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-3" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
  {% block content %}{% endblock %}
</main>

<!-- Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="toastContainer"></div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'core/js/modal_manager.js' %}"></script>
<script src="{% static 'core/js/delete_manager.js' %}"></script>
<script src="{% static 'core/js/inline_manager.js' %}"></script>
<script src="{% static 'core/js/duplicate_manager.js' %}"></script>

<script>
  // Fecha sidebar mobile ao clicar em um link
  document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('sidebarMobile');
    if (sidebar) {
      const links = sidebar.querySelectorAll('a.nav-link');
      links.forEach(link => {
        link.addEventListener('click', () => {
          const bsOffcanvas = bootstrap.Offcanvas.getInstance(sidebar);
          if (bsOffcanvas) bsOffcanvas.hide();
        });
      });
    }
  });
</script>
</body>
</html>
